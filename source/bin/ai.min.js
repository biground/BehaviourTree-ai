window.fsm={},window.behaviourTree={},window.utilityAI={},function(t){t.Behavior=class{constructor(){this.status=t.TaskStatus.Invalid}invalidate(){this.status=t.TaskStatus.Invalid}onStart(){}onEnd(){}tick(e){return this.status==t.TaskStatus.Invalid&&this.onStart(),this.status=this.update(e),this.status!=t.TaskStatus.Running&&this.onEnd(),this.status}}}(behaviourTree||(behaviourTree={})),function(t){t.BehaviorTree=class{constructor(t,e,i=.2){this._context=t,this._root=e,this.updatePeriod=this._elapsedTime=i}tick(){if(this.updatePeriod>0){if(this._elapsedTime-=es.Time.deltaTime,this._elapsedTime<=0){for(;this._elapsedTime<=0;)this._elapsedTime+=this.updatePeriod;this._root.tick(this._context)}}else this._root.tick(this._context)}}}(behaviourTree||(behaviourTree={})),function(t){class e{constructor(t){this._parentNodeStack=new Array,this._context=t}static begin(t){return new e(t)}setChildOnParent(e){let i=t.ArrayExt.peek(this._parentNodeStack);return i instanceof t.Composite?i.addChild(e):i instanceof t.Decorator&&(i.child=e,this.endDecorator()),this}pushParentNode(e){return this._parentNodeStack.length>0&&this.setChildOnParent(e),t.ArrayExt.push(this._parentNodeStack,e),this}endDecorator(){return this._currentNode=t.ArrayExt.pop(this._parentNodeStack),this}action(e){return t.Assert.isFalse(0==this._parentNodeStack.length,"无法创建无嵌套的动作节点, 它必须是一个叶节点"),this.setChildOnParent(new t.ExecuteAction(e))}actionR(e){return this.action(i=>e(i)?t.TaskStatus.Success:t.TaskStatus.Failure)}conditional(e){return t.Assert.isFalse(0==this._parentNodeStack.length,"无法创建无嵌套的条件节点, 它必须是一个叶节点"),this.setChildOnParent(new t.ExecuteActionConditional(e))}conditionalR(e){return this.conditional(i=>e(i)?t.TaskStatus.Success:t.TaskStatus.Failure)}logAction(e){return t.Assert.isFalse(0==this._parentNodeStack.length,"无法创建无嵌套的动作节点, 它必须是一个叶节点"),this.setChildOnParent(new t.LogAction(e))}waitAction(e){return t.Assert.isFalse(0==this._parentNodeStack.length,"无法创建无嵌套的动作节点, 它必须是一个叶节点"),this.setChildOnParent(new t.WaitAciton(e))}subTree(e){return t.Assert.isFalse(0==this._parentNodeStack.length,"无法创建无嵌套的动作节点, 它必须是一个叶节点"),this.setChildOnParent(new t.BehaviorTreeReference(e))}conditionalDecorator(e,i=!0){let s=new t.ExecuteActionConditional(e);return this.pushParentNode(new t.ConditionalDecorator(s,i))}conditionalDecoratorR(e,i=!0){return this.conditionalDecorator(i=>e(i)?t.TaskStatus.Success:t.TaskStatus.Failure,i)}alwaysFail(){return this.pushParentNode(new t.AlwaysFail)}alwaysSucceed(){return this.pushParentNode(new t.AlwaysSucceed)}inverter(){return this.pushParentNode(new t.Inverter)}repeater(e){return this.pushParentNode(new t.Repeater(e))}untilFail(){return this.pushParentNode(new t.UntilFail)}untilSuccess(){return this.pushParentNode(new t.UntilSuccess)}paraller(){return this.pushParentNode(new t.Parallel)}parallelSelector(){return this.pushParentNode(new t.ParallelSelector)}selector(e=t.AbortTypes.None){return this.pushParentNode(new t.Selector(e))}randomSelector(){return this.pushParentNode(new t.RandomSelector)}sequence(e=t.AbortTypes.None){return this.pushParentNode(new t.Sequence(e))}randomSequence(){return this.pushParentNode(new t.RandomSequence)}endComposite(){return t.Assert.isTrue(t.ArrayExt.peek(this._parentNodeStack)instanceof t.Composite,"尝试结束复合器，但顶部节点是装饰器"),this._currentNode=t.ArrayExt.pop(this._parentNodeStack),this}build(e=.2){if(!this._currentNode)throw new Error("无法创建零节点的行为树");return new t.BehaviorTree(this._context,this._currentNode,e)}}t.BehaviorTreeBuilder=e}(behaviourTree||(behaviourTree={})),function(t){let e;!function(t){t[t.Invalid=0]="Invalid",t[t.Success=1]="Success",t[t.Failure=2]="Failure",t[t.Running=3]="Running"}(e=t.TaskStatus||(t.TaskStatus={}))}(behaviourTree||(behaviourTree={})),function(t){t.BehaviorTreeReference=class extends t.Behavior{constructor(t){super(),this._childTree=t}update(e){return this._childTree.tick(),t.TaskStatus.Success}}}(behaviourTree||(behaviourTree={})),function(t){t.ExecuteAction=class extends t.Behavior{constructor(t){super(),this._action=t}update(e){return t.Assert.isNotNull(this._action,"action 必须不为空"),this._action(e)}}}(behaviourTree||(behaviourTree={})),function(t){t.LogAction=class extends t.Behavior{constructor(t){super(),this.isError=!1,this.text=t}update(e){return this.isError?console.error(this.text):console.log(this.text),t.TaskStatus.Success}}}(behaviourTree||(behaviourTree={})),function(t){t.WaitAciton=class extends t.Behavior{constructor(t){super(),this._startTime=0,this.waitTime=t}onStart(){this._startTime=0}update(e){return 0==this._startTime&&(this._startTime=es.Time.totalTime),es.Time.totalTime-this._startTime>=this.waitTime?t.TaskStatus.Success:t.TaskStatus.Running}}}(behaviourTree||(behaviourTree={})),function(t){let e;!function(t){t[t.None=0]="None",t[t.LowerPriority=1]="LowerPriority",t[t.Self=2]="Self",t[t.Both=3]="Both"}(e=t.AbortTypes||(t.AbortTypes={}));t.AbortTypesExt=class{static has(t,e){return(t&e)==e}}}(behaviourTree||(behaviourTree={})),function(t){t.Composite=class extends t.Behavior{constructor(){super(...arguments),this.abortType=t.AbortTypes.None,this._children=new Array,this._hasLowerPriorityConditionalAbort=!1,this._currentChildIndex=0}invalidate(){super.invalidate();for(let t=0;t<this._children.length;t++)this._children[t].invalidate()}onStart(){this._hasLowerPriorityConditionalAbort=this.hasLowerPriorityConditionalAbortInChildren(),this._currentChildIndex=0}onEnd(){for(let t=0;t<this._children.length;t++)this._children[t].invalidate()}hasLowerPriorityConditionalAbortInChildren(){for(let e=0;e<this._children.length;e++){let i=this._children[e];if(null!=i&&t.AbortTypesExt.has(i.abortType,t.AbortTypes.LowerPriority)&&i.isFirstChildConditional())return!0}return!1}addChild(t){this._children.push(t)}isFirstChildConditional(){return t.isIConditional(this._children[0])}updateSelfAbortConditional(e,i){for(let s=0;s<this._currentChildIndex;s++){let r=this._children[s];if(t.isIConditional(r)&&this.updateConditionalNode(e,r)!=i){this._currentChildIndex=s;for(let t=s;t<this._children.length;t++)this._children[t].invalidate();break}}}updateLowerPriorityAbortConditional(e,i){for(let s=0;s<this._currentChildIndex;s++){let r=this._children[s];if(null!=r&&t.AbortTypesExt.has(r.abortType,t.AbortTypes.LowerPriority)){let t=r._children[0];if(this.updateConditionalNode(e,t)!=i){this._currentChildIndex=s;for(let t=s;t<this._children.length;t++)this._children[t].invalidate();break}}}}updateConditionalNode(e,i){return i instanceof t.ConditionalDecorator?i.executeConditional(e,!0):i.update(e)}}}(behaviourTree||(behaviourTree={})),function(t){t.Parallel=class extends t.Composite{update(e){let i=!0;for(let s=0;s<this._children.length;s++){let r=this._children[s];if(r.tick(e),r.status==t.TaskStatus.Failure)return t.TaskStatus.Failure;r.status!=t.TaskStatus.Success&&(i=!1)}return i?t.TaskStatus.Success:t.TaskStatus.Running}}}(behaviourTree||(behaviourTree={})),function(t){t.ParallelSelector=class extends t.Composite{update(e){let i=!0;for(let s=0;s<this._children.length;s++){let r=this._children[s];if(r.tick(e),r.status==t.TaskStatus.Success)return t.TaskStatus.Success;r.status!=t.TaskStatus.Failure&&(i=!1)}return i?t.TaskStatus.Failure:t.TaskStatus.Running}}}(behaviourTree||(behaviourTree={})),function(t){t.Selector=class extends t.Composite{constructor(e=t.AbortTypes.None){super(),this.abortType=e}update(e){0!=this._currentChildIndex&&this.handleConditionalAborts(e);let i=this._children[this._currentChildIndex].tick(e);return i!=t.TaskStatus.Failure?i:(this._currentChildIndex++,this._currentChildIndex==this._children.length?(this._currentChildIndex=0,t.TaskStatus.Failure):t.TaskStatus.Running)}handleConditionalAborts(e){this._hasLowerPriorityConditionalAbort&&this.updateLowerPriorityAbortConditional(e,t.TaskStatus.Failure),t.AbortTypesExt.has(this.abortType,t.AbortTypes.Self)&&this.updateSelfAbortConditional(e,t.TaskStatus.Failure)}}}(behaviourTree||(behaviourTree={})),function(t){t.RandomSelector=class extends t.Selector{onStart(){t.ArrayExt.shuffle(this._children)}}}(behaviourTree||(behaviourTree={})),function(t){t.Sequence=class extends t.Composite{constructor(e=t.AbortTypes.None){super(),this.abortType=e}update(e){0!=this._currentChildIndex&&this.handleConditionalAborts(e);let i=this._children[this._currentChildIndex].tick(e);return i!=t.TaskStatus.Success?i:(this._currentChildIndex++,this._currentChildIndex==this._children.length?(this._currentChildIndex=0,t.TaskStatus.Success):t.TaskStatus.Running)}handleConditionalAborts(e){this._hasLowerPriorityConditionalAbort&&this.updateLowerPriorityAbortConditional(e,t.TaskStatus.Success),t.AbortTypesExt.has(this.abortType,t.AbortTypes.Self)&&this.updateSelfAbortConditional(e,t.TaskStatus.Success)}}}(behaviourTree||(behaviourTree={})),function(t){t.RandomSequence=class extends t.Sequence{onStart(){t.ArrayExt.shuffle(this._children)}}}(behaviourTree||(behaviourTree={})),function(t){t.ExecuteActionConditional=class extends t.ExecuteAction{constructor(t){super(t),this.discriminator="IConditional"}}}(behaviourTree||(behaviourTree={})),function(t){t.isIConditional=function(t){return"IConditional"===t.discriminator}}(behaviourTree||(behaviourTree={})),function(t){t.RandomProbability=class extends t.Behavior{constructor(t){super(),this.discriminator="IConditional",this._successProbability=t}update(e){return Math.random()>this._successProbability?t.TaskStatus.Success:t.TaskStatus.Failure}}}(behaviourTree||(behaviourTree={})),function(t){t.Decorator=class extends t.Behavior{invalidate(){super.invalidate(),this.child.invalidate()}}}(behaviourTree||(behaviourTree={})),function(t){t.AlwaysFail=class extends t.Decorator{update(e){return t.Assert.isNotNull(this.child,"child必须不能为空"),this.child.update(e)==t.TaskStatus.Running?t.TaskStatus.Running:t.TaskStatus.Failure}}}(behaviourTree||(behaviourTree={})),function(t){t.AlwaysSucceed=class extends t.Decorator{update(e){return t.Assert.isNotNull(this.child,"child必须不能为空"),this.child.update(e)==t.TaskStatus.Running?t.TaskStatus.Running:t.TaskStatus.Success}}}(behaviourTree||(behaviourTree={})),function(t){t.ConditionalDecorator=class extends t.Decorator{constructor(e,i=!0){super(),this.discriminator="IConditional",this._conditionalStatus=t.TaskStatus.Invalid,t.Assert.isTrue(t.isIConditional(e),"conditional 必须继承 IConditional"),this._conditional=e,this._shouldReevaluate=i}invalidate(){super.invalidate(),this._conditionalStatus=t.TaskStatus.Invalid}onStart(){this._conditionalStatus=t.TaskStatus.Invalid}update(e){return t.Assert.isNotNull(this.child,"child不能为空"),this._conditionalStatus=this.executeConditional(e),this._conditionalStatus==t.TaskStatus.Success?this.child.tick(e):t.TaskStatus.Failure}executeConditional(e,i=!1){return(i||this._shouldReevaluate||this._conditionalStatus==t.TaskStatus.Invalid)&&(this._conditionalStatus=this._conditional.update(e)),this._conditionalStatus}}}(behaviourTree||(behaviourTree={})),function(t){t.Inverter=class extends t.Decorator{update(e){t.Assert.isNotNull(this.child,"child必须不能为空");let i=this.child.tick(e);return i==t.TaskStatus.Success?t.TaskStatus.Failure:i==t.TaskStatus.Failure?t.TaskStatus.Success:t.TaskStatus.Running}}}(behaviourTree||(behaviourTree={})),function(t){t.Repeater=class extends t.Decorator{constructor(t,e=!1){super(),this.repeatForever=!1,this._iterationCount=0,this.count=t,this.endOnFailure=e}onStart(){this._iterationCount=0}update(e){if(t.Assert.isNotNull(this.child,"child必须不能为空"),!this.repeatForever&&this._iterationCount==this.count)return t.TaskStatus.Success;let i=this.child.tick(e);return this._iterationCount++,this.endOnFailure&&i==t.TaskStatus.Failure?t.TaskStatus.Success:this.repeatForever||this._iterationCount!=this.count?t.TaskStatus.Running:t.TaskStatus.Success}}}(behaviourTree||(behaviourTree={})),function(t){t.UntilFail=class extends t.Decorator{update(e){return t.Assert.isNotNull(this.child,"child必须不为空"),this.child.update(e)!=t.TaskStatus.Failure?t.TaskStatus.Running:t.TaskStatus.Success}}}(behaviourTree||(behaviourTree={})),function(t){t.UntilSuccess=class extends t.Decorator{update(e){return t.Assert.isNotNull(this.child,"child必须不为空"),this.child.update(e)!=t.TaskStatus.Success?t.TaskStatus.Running:t.TaskStatus.Success}}}(behaviourTree||(behaviourTree={})),function(t){t.ArrayExt=class{static shuffle(e){let i=e.length-1;for(;i>1;){i--;let s=t.Random.range(0,i+1),r=e[s];e[s]=e[i],e[i]=r}}static peek(t){return t[0]}static push(t,e){t.splice(0,0,e)}static pop(t){return t.shift()}}}(behaviourTree||(behaviourTree={})),function(t){class e{static fail(t,...e){t?console.assert(!1,t,e):console.assert(!1)}static isTrue(t,i,...s){t||(i?e.fail(i,s):e.fail())}static isNotNull(t,i,...s){e.isTrue(null!=t,i,s)}static isFalse(t,e,...i){e?this.isTrue(!t,e,i):this.isTrue(!t)}}t.Assert=e}(behaviourTree||(behaviourTree={})),function(t){t.Random=class{static range(t,e){let i=(new Date).getTime();return(t=t||0)+(i=(9301*i+49297)%233280)/233280*((e=e||1)-t)}}}(behaviourTree||(behaviourTree={})),function(t){class e{}t.SimpleStateMachine=class extends es.Component{get currentState(){return this._currentState}set currentState(t){this._currentState!=t&&(this.previousState=this._currentState,this._currentState=t,null!=this._stateMethods.exitState&&this._stateMethods.exitState.call(this),this.elapsedTimeInState=0,this._stateMethods=this._stateCache.get(this._currentState),null!=this._stateMethods.enterState&&this._stateMethods.enterState.call(this))}set initialState(t){this._currentState=t,this._stateMethods=this._stateCache.get(this._currentState),null!=this._stateMethods.enterState&&this._stateMethods.enterState.call(this)}constructor(t){super(),this.elapsedTimeInState=0,this._stateCache=new Map;for(let e in t)this.configureAndCacheState(t,t[e])}configureAndCacheState(t,i){let s=t[i],r=new e;r.enterState=this[s+"_enter"],r.tick=this[s+"_tick"],r.exitState=this[s+"_exit"],this._stateCache.set(i,r)}update(){this.elapsedTimeInState+=es.Time.deltaTime,null!=this._stateMethods.tick&&this._stateMethods.tick.call(this)}}}(fsm||(fsm={})),function(t){t.State=class{setMachineAndContext(t,e){this._machine=t,this._context=e,this.onInitialized()}onInitialized(){}begin(){}reason(){}end(){}}}(fsm||(fsm={})),function(t){t.StateMachine=class{get currentState(){return this._currentState}constructor(t,e){this.elapsedTimeInState=0,this._states=new Map,this._context=t,this.addState(e),this._currentState=e,this._currentState.begin()}addState(t){t.setMachineAndContext(this,this._context),this._states.set(es.TypeUtils.getType(t),t)}update(t){this.elapsedTimeInState+=t,this._currentState.reason(),this._currentState.update(t)}getState(t){return this._states.has(t)?this._states.get(t):(console.error(`状态${t}不存在。你是不是在调用addState的时候忘记添加了?`),null)}changeState(t){if(this._currentState instanceof t)return this._currentState;if(this.currentState&&this._currentState.end(),!this._states.has(t))return console.error(`状态${t}不存在。你是不是在调用addState的时候忘记添加了?`),null;this.elapsedTimeInState=0,this.previousState=this._currentState;let e=this._states.get(t);return e&&(this._currentState=e),this._currentState.begin(),null!=this.onStateChanged&&this.onStateChanged(),this._currentState}}}(fsm||(fsm={})),function(t){t.UtilityAI=class{constructor(t,e,i=.2){this._rootReasoner=e,this._context=t,this.updatePeriod=this._elapsedTime=i}tick(){for(this._elapsedTime-=es.Time.deltaTime;this._elapsedTime<=0;){this._elapsedTime+=this.updatePeriod;let t=this._rootReasoner.select(this._context);null!=t&&t.execute(this._context)}}}}(utilityAI||(utilityAI={})),function(t){t.ActionExecutor=class{constructor(t){this._action=t}execute(t){this._action(t)}}}(utilityAI||(utilityAI={})),function(t){t.ActionWithOptions=class{constructor(){this._appraisals=new Array}getBestOption(t,e){let i=null,s=-3.402823e38;for(let r=0;r<e.length;r++){let n=e[r],a=0;for(let e=0;e<this._appraisals.length;e++)a+=this._appraisals[e].getScore(t,n);a>s&&(s=a,i=n)}return i}addScorer(t){return this._appraisals.push(t),this}}}(utilityAI||(utilityAI={})),function(t){t.CompositeAction=class{constructor(){this._actions=new Array}execute(t){for(let e=0;e<this._actions.length;e++)this._actions[e].execute(t)}addAction(t){return this._actions.push(t),this}}}(utilityAI||(utilityAI={})),function(t){t.LogAction=class{constructor(t){this._text=t}execute(t){console.log(this._text)}}}(utilityAI||(utilityAI={})),function(t){t.ReasonerAction=class{constructor(t){this._reasoner=t}execute(t){let e=this._reasoner.select(t);null!=e&&e.execute(t)}}}(utilityAI||(utilityAI={})),function(t){t.AllOrNothingConsideration=class{constructor(t=0){this._appraisals=new Array,this.threshold=t}addAppraisal(t){return this._appraisals.push(t),this}getScore(t){let e=0;for(let i=0;i<this._appraisals.length;i++){let s=this._appraisals[i].getScore(t);if(s<this.threshold)return 0;e+=s}return e}}}(utilityAI||(utilityAI={})),function(t){t.FixedScoreConsideration=class{constructor(t=1){this.score=t}getScore(t){return this.score}}}(utilityAI||(utilityAI={})),function(t){t.SumOfChildrenConsideration=class{constructor(){this._appraisals=new Array}getScore(t){let e=0;for(let i=0;i<this._appraisals.length;i++)e+=this._appraisals[i].getScore(t);return e}}}(utilityAI||(utilityAI={})),function(t){t.ThresholdConsideration=class{constructor(t){this._appraisals=new Array,this.threshold=t}getScore(t){let e=0;for(let i=0;i<this._appraisals.length;i++){let s=this._appraisals[i].getScore(t);if(s<this.threshold)return e;e+=s}return e}}}(utilityAI||(utilityAI={})),function(t){t.ActionAppraisal=class{constructor(t){this._appraisalAction=t}getScore(t){return this._appraisalAction(t)}}}(utilityAI||(utilityAI={})),function(t){t.Reasoner=class{constructor(){this.defaultConsideration=new t.FixedScoreConsideration,this._condiderations=new Array}select(t){let e=this.selectBestConsideration(t);return null!=e?e.action:null}addConsideration(t){return this._condiderations.push(t),this}setDefaultConsideration(t){return this.defaultConsideration=t,this}}}(utilityAI||(utilityAI={})),function(t){t.FirstScoreReasoner=class extends t.Reasoner{selectBestConsideration(t){let e=this.defaultConsideration.getScore(t);for(let i=0;i<this._condiderations.length;i++)if(this._condiderations[i].getScore(t)>=e)return this._condiderations[i];return this.defaultConsideration}}}(utilityAI||(utilityAI={})),function(t){t.HighestScoreReasoner=class extends t.Reasoner{selectBestConsideration(t){let e=this.defaultConsideration.getScore(t),i=null;for(let s=0;s<this._condiderations.length;s++){let r=this._condiderations[s].getScore(t);r>e&&(e=r,i=this._condiderations[s])}return null==i?this.defaultConsideration:i}}}(utilityAI||(utilityAI={}));